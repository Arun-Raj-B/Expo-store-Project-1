<section
  style="padding-top: 250px; padding-bottom: 250px; background-color: #ece6d9"
>
  <div class="container h-75 d-flex justify-content-center align-items-center">
    <div class="position-relative">
      <div
        class="card card-work p-2 shadow text-center"
        style="width: 22rem; height: 18rem"
      >
        <form action="/otp" method="post">
          <h6 class="p-3">
            Please enter the one time password <br />
            to verify your account
          </h6>
          <div>
            <% if (locals.OTPerr) { %>
            <p class="text-danger m-auto"><%= locals.OTPerr %></p>
            <% } %>
            <span>A code has been sent to</span>
            <small>*******<%=locals.last4digits%> </small>
          </div>
          <div
            id="otp"
            class="inputs d-flex flex-row justify-content-center mt-2"
          >
            <input
              class="m-2 text-center form-control rounded"
              type="text"
              name="otp"
              id="first"
              maxlength="6"
            />
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-danger px-4 validate">
              Validate
            </button>
          </div>
        </form>
        <div class="mt-2">
          <a
            id="resendOTP"
            class="text-success text-decoration-none"
            style="cursor: pointer; display: none"
          >
            Resend OTP (<span id="OTPcount"></span>/3)
          </a>
          <div id="otp-text">
            Resend OTP in <span id="timer"></span> seconds
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  let seconds = 10;
  let timer;
  let OTPcount = 0;
  console.log(timer);
  function myFunction() {
    if (seconds < 10) {
      // I want it to say 1:00, not 60
      document.getElementById("timer").innerHTML = seconds;
    }
    if (seconds > 0) {
      // so it doesn't go to -1
      seconds--;
    } else {
      clearInterval(timer);
      document.getElementById("OTPcount").innerHTML = OTPcount++;
      document.getElementById("resendOTP").style.display = "block";
      document.getElementById("otp-text").style.display = "none";
    }
  }

  function counter() {
    console.log("working");
    if (!timer) {
      console.log("timer working");
      timer = window.setInterval(function () {
        myFunction();
      }, 1000); // every second
    }
  }
  document.getElementById("timer").innerHTML = "10";

  //to start counter when the page loads
  counter();

  document.getElementById("resendOTP").onclick = function () {
    if (OTPcount == "4") {
      window.location.href = "/login";
    } else {
      $.ajax({
        url: "/resendOTP",
        method: "post",
        success: (response) => {
          console.log(response);
          timer = false;
          seconds = 10;
          document.getElementById("timer").innerHTML = "10";
          document.getElementById("resendOTP").style.display = "none";
          document.getElementById("otp-text").style.display = "block";
          counter();
        },
      });
    }
  };
</script>
